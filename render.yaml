# This top-level key is for managed databases
databases:
  - name: parkease-db
    plan: free # 'starter' is recommended for production
    engine: mysql
    databaseName: ${MYSQL_DATABASE}   # From your env group
    databaseUser: ${MYSQL_USER}     # From your env group

# This top-level key is for services like web servers, APIs, etc.
services:
  # 1. The Spring Boot Backend
  - type: web
    name: parkease-backend
    plan: free # 'starter' is recommended for production
    runtime: docker
    region: ohio
    dockerContext: ./parkease-api
    dockerfilePath: ./parkease-api/Dockerfile
    envVars:
      # --- Automatic DB Connection (Render provides these) ---
      - key: DB_HOST
        fromService:
          type: database  # Corrected: Must be 'database'
          name: parkease-db
          property: host
      - key: DB_PORT
        fromService:
          type: database # Corrected: Must be 'database'
          name: parkease-db
          property: port
      - key: SPRING_DATASOURCE_URL
        value: jdbc:mysql://${DB_HOST}:${DB_PORT}/${MYSQL_DATABASE}
      - key: SPRING_DATASOURCE_USERNAME
        fromService:
          type: database # Corrected: Must be 'database'
          name: parkease-db
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromService:
          type: database # Corrected: Must be 'database'
          name: parkease-db
          property: password
      # --- Your Secrets (from the Environment Group) ---
      - key: APP_JWT_SECRET
        fromGroup: parkease-secrets
        key: JWT_SECRET
      - key: SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT-ID
        fromGroup: parkease-secrets
        key: GOOGLE_CLIENT_ID
      - key: SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT-SECRET
        fromGroup: parkease-secrets
        key: GOOGLE_CLIENT_SECRET
      - key: RADAR_API_KEY
        fromGroup: parkease-secrets
        key: RADAR_SECRET_KEY
      - key: MYSQL_DATABASE # Needed for the URL variable above
        fromGroup: parkease-secrets

  # 2. The React Frontend (as a Docker Web Service)
  - type: web
    name: parkease-frontend
    plan: free
    region: ohio
    runtime: docker
    dockerContext: ./parkease-frontend
    dockerfilePath: ./parkease-frontend/Dockerfile
    # These env vars are injected at BUILD time (for Vite)
    envVars:
      - key: VITE_API_BASE
        value: /api
      - key: VITE_RADAR_PUBLISHABLE_KEY
        fromGroup: parkease-secrets
      - key: VITE_GOOGLE_CLIENT_ID
        fromGroup: parkease-secrets

# --- Environment Group Definition ---
envVarGroups:
  - name: parkease-secrets